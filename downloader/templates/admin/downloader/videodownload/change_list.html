{% extends "admin/change_list.html" %}
{% load i18n admin_urls static admin_list %}

{% block extrahead %}
    {{ block.super }}
    <!-- Suppress unload permissions policy violation warning from Django admin -->
    <meta http-equiv="Permissions-Policy" content="unload=(self)">
{% endblock %}

{% block result_list %}
    <!-- Dashboard Stats -->
    <div style="margin-bottom: 20px; display: flex; gap: 20px; flex-wrap: wrap;">
        
        <!-- Total Videos -->
        <div style="flex: 1; min-width: 200px; background: #343a40; padding: 15px; border-radius: 8px; border-left: 5px solid #17a2b8; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h3 style="margin: 0; font-size: 14px; color: #adb5bd; text-transform: uppercase;">Total Videos</h3>
            <p style="margin: 5px 0 0; font-size: 24px; font-weight: bold; color: white;">{{ total_videos }}</p>
        </div>

        <!-- Downloaded -->
        <div style="flex: 1; min-width: 200px; background: #343a40; padding: 15px; border-radius: 8px; border-left: 5px solid #28a745; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h3 style="margin: 0; font-size: 14px; color: #adb5bd; text-transform: uppercase;">Saved Locally</h3>
            <p style="margin: 5px 0 0; font-size: 24px; font-weight: bold; color: white;">{{ downloaded_count }}</p>
            <small style="color: #6c757d;">Cloud Only: {{ cloud_only_count }}</small>
        </div>

        <!-- Success -->
        <div style="flex: 1; min-width: 200px; background: #343a40; padding: 15px; border-radius: 8px; border-left: 5px solid #28a745; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h3 style="margin: 0; font-size: 14px; color: #adb5bd; text-transform: uppercase;">Successful</h3>
            <p style="margin: 5px 0 0; font-size: 24px; font-weight: bold; color: white;">{{ success_count }}</p>
        </div>

        <!-- Failed -->
        <div style="flex: 1; min-width: 200px; background: #343a40; padding: 15px; border-radius: 8px; border-left: 5px solid #dc3545; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h3 style="margin: 0; font-size: 14px; color: #adb5bd; text-transform: uppercase;">Failed</h3>
            <p style="margin: 5px 0 0; font-size: 24px; font-weight: bold; color: white;">{{ failed_count }}</p>
        </div>

        <!-- Pending -->
        <div style="flex: 1; min-width: 200px; background: #343a40; padding: 15px; border-radius: 8px; border-left: 5px solid #ffc107; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h3 style="margin: 0; font-size: 14px; color: #adb5bd; text-transform: uppercase;">Pending</h3>
            <p style="margin: 5px 0 0; font-size: 24px; font-weight: bold; color: white;">{{ pending_count }}</p>
        </div>

        <!-- AI Processed -->
        <div style="flex: 1; min-width: 200px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; border-radius: 8px; border-left: 5px solid #28a745; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h3 style="margin: 0; font-size: 14px; color: rgba(255,255,255,0.8); text-transform: uppercase;">ðŸ¤– AI Processed</h3>
            <p style="margin: 5px 0 0; font-size: 24px; font-weight: bold; color: white;">{{ ai_processed_count }}</p>
            <small style="color: rgba(255,255,255,0.7);">
                Processing: {{ ai_processing_count }} | Not Processed: {{ ai_not_processed_count }}
            </small>
        </div>

    </div>

    {{ block.super }}
    
    <script>
    // Auto-refresh transcription status for videos being transcribed
    (function() {
        function updateTranscriptionStatus() {
            document.querySelectorAll('[data-transcribe-id]').forEach(function(badge) {
                const videoId = badge.getAttribute('data-transcribe-id');
                if (!videoId) return;
                
                // Use Django admin URL reverse pattern
                const statusUrl = '/admin/downloader/videodownload/transcription-status/' + videoId + '/';
                
                fetch(statusUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'same-origin'
                })
                    .then(response => {
                        // Check if response is OK and is JSON
                        if (!response.ok) {
                            throw new Error('HTTP error: ' + response.status);
                        }
                        const contentType = response.headers.get('content-type');
                        if (!contentType || !contentType.includes('application/json')) {
                            // If not JSON, stop polling for this item
                            badge.removeAttribute('data-transcribe-id');
                            return null;
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (!data) return; // Skip if not JSON
                        
                        // Update badge text with elapsed time
                        const currentText = badge.textContent.trim();
                        const icon = currentText.startsWith('âŸ³') ? 'âŸ³ ' : 
                                   currentText.startsWith('âœ—') ? 'âœ— ' : 
                                   currentText.startsWith('ðŸ“') ? 'ðŸ“ ' : 'âŸ³ ';
                        
                        let statusText = '';
                        if (data.status === 'transcribing') {
                            statusText = icon + 'Transcribing (' + data.elapsed_display + ')';
                        } else if (data.status === 'transcribed') {
                            statusText = 'ðŸ“ Transcribed';
                            badge.style.backgroundColor = '#28a745';
                            badge.removeAttribute('data-transcribe-id');
                        } else if (data.status === 'failed') {
                            statusText = 'âœ— Failed';
                            badge.style.backgroundColor = '#dc3545';
                            badge.removeAttribute('data-transcribe-id');
                        }
                        
                        if (statusText) {
                            badge.textContent = statusText;
                        }
                        
                        // Remove from polling if completed
                        if (data.status !== 'transcribing') {
                            badge.removeAttribute('data-transcribe-id');
                        }
                    })
                    .catch(error => {
                        // Silently fail - don't spam console
                        // Only log if it's not a network error
                        if (error.name !== 'TypeError') {
                            console.error('Error checking transcription status:', error);
                        }
                        // Stop polling if there's an error
                        badge.removeAttribute('data-transcribe-id');
                    });
            });
        }
        
        // Wait for page to load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                setTimeout(function() {
                    if (document.querySelectorAll('[data-transcribe-id]').length > 0) {
                        setInterval(updateTranscriptionStatus, 3000);
                        updateTranscriptionStatus(); // Initial update
                    }
                }, 1000);
            });
        } else {
            // Page already loaded
            if (document.querySelectorAll('[data-transcribe-id]').length > 0) {
                setInterval(updateTranscriptionStatus, 3000);
                setTimeout(updateTranscriptionStatus, 1000); // Initial update after 1 second
            }
        }
    })();
    
    // Audio Prompt Generation function
    function generateAudioPrompt(videoId) {
        if (!confirm('Generate audio prompt for this video? This will use your configured AI provider API.')) {
            return;
        }
        
        const apiUrl = window.location.origin + '/api/generate-audio-prompt/';
        
        fetch(apiUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ video_id: videoId })
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => Promise.reject(err));
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'success') {
                alert('Audio prompt generated successfully!');
                window.location.reload();
            } else {
                alert('Error: ' + (data.error || 'Failed to generate audio prompt'));
            }
        })
        .catch(error => {
            alert('Error: ' + error.message);
        });
    }
    
    // Helper to get CSRF cookie
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    </script>
{% endblock %}
